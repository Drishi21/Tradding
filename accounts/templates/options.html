{% extends "base.html" %}
{% block content %}

<!-- Options Order Form -->
<div class="card p-4 mb-4 shadow-sm">
  <h4>üìù Options Order</h4>
  <form method="post" action="{% url 'options_order' %}">
    {% csrf_token %}
    <div class="row mb-3">
      <div class="col-md-2">
        <label>Symbol</label>
        <input class="form-control" id="symbol" name="symbol" value="NIFTY">
      </div>
      <div class="col-md-3">
        <label>Expiry</label>
        <select class="form-select" id="expiry" name="expiry">
          {% for exp in expiries %}
          <option value="{{ exp }}">{{ exp }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label>Strike</label>
        <input class="form-control" id="strike" name="strike" value="{{ atm_strike }}">
      </div>
      <div class="col-md-2">
        <label>Option Type</label>
        <select class="form-select" id="option_type" name="option_type">
          <option value="CE">CE</option>
          <option value="PE">PE</option>
        </select>
      </div>
      <div class="col-md-3">
        <label>Lot Size</label>
        <select class="form-select" id="lotSize" name="quantity">
          <option value="50">1 Lot (50)</option>
          <option value="100">2 Lots (100)</option>
          <option value="150">3 Lots (150)</option>
          <option value="200">4 Lots (200)</option>
          <option value="250">5 Lots (250)</option>
        </select>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col-md-3">
        <label>Order Type</label>
        <select class="form-select" name="orderType">
          <option value="MARKET">Market</option>
          <option value="LIMIT">Limit</option>
        </select>
      </div>
      <div class="col-md-3">
        <label>Price (for Limit)</label>
        <input type="number" step="0.05" class="form-control" name="price">
      </div>
    </div>
    <button class="btn btn-success">üöÄ Place Options Order</button>
  </form>
</div>

<!-- Underlying & Option Chart -->
<div class="row">
  <div class="col-md-6"><div id="underlying_chart" style="height:400px;"></div></div>
  <div class="col-md-6"><div id="option_chart" style="height:400px;"></div></div>
</div>

<!-- Option Chain Table with Quick Buy/Sell -->
<div class="card p-4 mt-4 shadow-sm">
  <h4>üß© Live Option Chain</h4>
  <div class="mb-3">
    <label><b>Lot Size for Quick Orders</b></label>
    <select class="form-select w-auto d-inline" id="quickLotSize">
      <option value="50">1 Lot (50)</option>
      <option value="100">2 Lots (100)</option>
      <option value="150">3 Lots (150)</option>
      <option value="200">4 Lots (200)</option>
      <option value="250">5 Lots (250)</option>
    </select>
  </div>
  <table class="table table-bordered text-center align-middle" id="optionChainTable">
    <thead class="table-dark">
      <tr>
        <th>Strike</th>
        <th>CE LTP</th>
        <th>PE LTP</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for row in option_chain %}
      <tr data-strike="{{ row.strike }}">
        <td><b>{{ row.strike }}</b></td>
        <td class="ce-ltp">{{ row.CE }}</td>
        <td class="pe-ltp">{{ row.PE }}</td>
        <td>
          <!-- Quick Buy/Sell Buttons -->
          <form method="post" action="{% url 'options_order' %}" class="quick-order d-inline">
            {% csrf_token %}
            <input type="hidden" name="symbol" value="NIFTY">
            <input type="hidden" name="expiry" class="expiry-field">
            <input type="hidden" name="strike" value="{{ row.strike }}">
            <input type="hidden" name="option_type" value="CE">
            <input type="hidden" name="quantity" class="lot-field">
            <input type="hidden" name="orderType" value="MARKET">
            <button class="btn btn-sm btn-success">Buy CE</button>
          </form>

          <form method="post" action="{% url 'options_order' %}" class="quick-order d-inline">
            {% csrf_token %}
            <input type="hidden" name="symbol" value="NIFTY">
            <input type="hidden" name="expiry" class="expiry-field">
            <input type="hidden" name="strike" value="{{ row.strike }}">
            <input type="hidden" name="option_type" value="PE">
            <input type="hidden" name="quantity" class="lot-field">
            <input type="hidden" name="orderType" value="MARKET">
            <button class="btn btn-sm btn-primary">Buy PE</button>
          </form>

          <form method="post" action="{% url 'options_order' %}" class="quick-order d-inline">
            {% csrf_token %}
            <input type="hidden" name="symbol" value="NIFTY">
            <input type="hidden" name="expiry" class="expiry-field">
            <input type="hidden" name="strike" value="{{ row.strike }}">
            <input type="hidden" name="option_type" value="CE">
            <input type="hidden" name="quantity" class="lot-field-negative">
            <input type="hidden" name="orderType" value="MARKET">
            <button class="btn btn-sm btn-danger">Sell CE</button>
          </form>

          <form method="post" action="{% url 'options_order' %}" class="quick-order d-inline">
            {% csrf_token %}
            <input type="hidden" name="symbol" value="NIFTY">
            <input type="hidden" name="expiry" class="expiry-field">
            <input type="hidden" name="strike" value="{{ row.strike }}">
            <input type="hidden" name="option_type" value="PE">
            <input type="hidden" name="quantity" class="lot-field-negative">
            <input type="hidden" name="orderType" value="MARKET">
            <button class="btn btn-sm btn-warning text-dark">Sell PE</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- TradingView + WebSocket Scripts -->
<script src="https://s3.tradingview.com/tv.js"></script>
<script>
  // Update expiry + lot size in all quick-order forms
  function updateQuickOrderFields() {
    const expiry = document.getElementById("expiry").value;
    const lotSize = document.getElementById("quickLotSize").value;

    document.querySelectorAll(".expiry-field").forEach(field => {
      field.value = expiry;
    });

    document.querySelectorAll(".lot-field").forEach(field => {
      field.value = lotSize;
    });

    document.querySelectorAll(".lot-field-negative").forEach(field => {
      field.value = "-" + lotSize;
    });
  }

  document.getElementById("expiry").addEventListener("change", updateQuickOrderFields);
  document.getElementById("quickLotSize").addEventListener("change", updateQuickOrderFields);
  window.onload = updateQuickOrderFields;

  // Live Option Chain via WebSocket
  const ws = new WebSocket("ws://" + window.location.host + "/ws/option-chain/");
  ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    data.option_chain.forEach(c => {
      const row = document.querySelector(`tr[data-strike='${c.strike}']`);
      if (row) {
        if (c.type === "CE") row.querySelector(".ce-ltp").innerText = c.ltp || "-";
        if (c.type === "PE") row.querySelector(".pe-ltp").innerText = c.ltp || "-";
      }
    });
  };

  // Load TradingView Charts
  function loadCharts() {
    const symbol = document.getElementById("symbol").value.toUpperCase();
    const expiry = document.getElementById("expiry").value.replace(/-/g,"");
    const strike = document.getElementById("strike").value;
    const optType = document.getElementById("option_type").value;

    new TradingView.widget({
      "width":"100%", "height":400, "symbol":"NSE:"+symbol,
      "interval":"5", "theme":"light", "container_id":"underlying_chart"
    });

    const optionSymbol = symbol+expiry+strike+optType;
    new TradingView.widget({
      "width":"100%", "height":400, "symbol":"NSE:"+optionSymbol,
      "interval":"5", "theme":"light", "container_id":"option_chart"
    });
  }

  document.querySelectorAll("#symbol,#expiry,#strike,#option_type")
    .forEach(el => el.addEventListener("change", loadCharts));
  window.onload = () => {
    updateQuickOrderFields();
    loadCharts();
  };
</script>

{% endblock %}
