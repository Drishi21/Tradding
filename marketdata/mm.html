{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NIFTY Market Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">


<style>
/* --- Reset & Base --- */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:#f4f6f8;color:#333;}
.container{max-width:1400px;margin:auto;padding:15px;}

/* --- Header --- */
.header{display:flex;align-items:center;justify-content:space-between;
  background:#fff;padding:15px 25px;border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-bottom:20px;}
.header .logo{display:flex;align-items:center;}
.header .logo img{width:40px;height:40px;margin-right:12px;}
.header .title{font-size:1.6rem;font-weight:700;color:#2c3e50;}

/* --- Controls --- */
.controls{display:flex;flex-wrap:wrap;gap:15px;align-items:center;
  background:#fff;padding:20px;border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,0.05);margin-bottom:25px;}
.controls select,.controls button{padding:10px 16px;border:1px solid #ccc;border-radius:8px;
  font-size:14px;cursor:pointer;}
.controls .btn-submit{background:#5a67d8;color:white;border:none;}
.controls .btn-update{background:#38a169;color:white;border:none;}
.controls .btn-reset{background:#e53e3e;color:white;border:none;}

/* --- Summary Cards --- */
.summary-cards{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:25px;}
.summary-card{flex:1 1 200px;background:#fff;border-radius:12px;
  padding:15px;box-shadow:0 4px 10px rgba(0,0,0,0.05);
  text-align:center;font-weight:600;font-size:14px;}
.summary-card.bullish{border:2px solid #38a169;color:#38a169;}
.summary-card.bearish{border:2px solid #e53e3e;color:#e53e3e;}
.summary-card.neutral{border:2px solid #718096;color:#2d3748;}
.progress{width:100%;background:#edf2f7;border-radius:8px;height:8px;margin-top:8px;overflow:hidden;}
.progress-bar{height:100%;border-radius:8px;}
.progress-bar.bullish{background:#38a169;}
.progress-bar.bearish{background:#e53e3e;}
.progress-bar.neutral{background:#718096;}

/* --- Trade Snippets styled like Summary --- */
.snippets-wrapper{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:30px;}
.snippet{flex:1 1 200px;background:#fff;border-radius:12px;padding:15px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);text-align:center;
  font-weight:600;font-size:14px;}
.snippet.bullish{border:2px solid #38a169;color:#38a169;}
.snippet.bearish{border:2px solid #e53e3e;color:#e53e3e;}
.snippet .day-label{font-size:0.85rem;margin-bottom:6px;}
.snippet .trend{font-size:1.1rem;margin-bottom:4px;}
.snippet .trade{font-weight:500;}

/* --- Table --- */
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;
  box-shadow:0 4px 20px rgba(0,0,0,0.05);margin-bottom:20px;}
thead{background:linear-gradient(135deg,#5a67d8,#7b2ff7);color:#fff;}
th,td{padding:10px;text-align:center;font-size:14px;}
tr:nth-child(even){background:#f8f9fa;}
tr:hover{background:#edf2ff;}
.points-positive{color:#38a169;font-weight:bold;}
.points-negative{color:#e53e3e;font-weight:bold;}
.bullish{color:#38a169;font-weight:bold;}
.bearish{color:#e53e3e;font-weight:bold;}
.neutral{color:#718096;font-weight:bold;}

/* --- Accordion Buttons --- */
.btn-toggle {
  background:#f3f4f6;
  border:1px solid #ccc;
  border-radius:6px;
  padding:4px 10px;
  font-size:13px;
  cursor:pointer;
  transition:all 0.2s ease;
}
.btn-toggle:hover { background:#e2e8f0; }
.btn-toggle.active {
  background:linear-gradient(135deg,#7b2ff7,#5a67d8);
  color:white;font-weight:600;border:none;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
}

/* --- Accordion Content --- */
.accordion-content{display:none;background:#f9fafb;}
.accordion-content.active{display:table-row-group;}

/* Accordion Headers */
.accordion-header{
  text-align:left;font-weight:700;padding:10px;
  border-radius:8px 8px 0 0;color:#fff;margin-bottom:5px;
}
.accordion-header.hourly{background:linear-gradient(135deg,#5a67d8,#7b2ff7);}
.accordion-header.m30{background:linear-gradient(135deg,#38a169,#2f855a);}

/* Accordion Tables */
.accordion-content table{width:100%;border-collapse:collapse;margin-top:8px;
  border-radius:8px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.accordion-content th{font-size:13px;font-weight:600;padding:8px;text-align:center;color:#fff;}
.accordion-content.hourly th{background:linear-gradient(135deg,#5a67d8,#7b2ff7);}
.accordion-content.m30 th{background:linear-gradient(135deg,#38a169,#2f855a);}
.accordion-content td{padding:8px;text-align:center;font-size:13px;}
.accordion-content.hourly tr:nth-child(even){background:#f0f2ff;} /* light purple */
.accordion-content.m30 tr:nth-child(even){background:#e6f9f0;}  /* light green */
.accordion-content tr:hover{background:#e9f0ff;}
.accordion-content .points-positive{color:#38a169;font-weight:600;}
.accordion-content .points-negative{color:#e53e3e;font-weight:600;}
/* Net Wrapper */
.net-wrapper { text-align:center; }
.net-value { font-weight:600; display:block; margin-bottom:2px; }
.net-value.pos { color:#38a169; }   /* Green */
.net-value.neg { color:#e53e3e; }   /* Red */
.net-value.neu { color:#718096; }   /* Gray */

.net-bar {
  width:80px; height:6px;
  background:#edf2f7;
  border-radius:4px;
  margin:0 auto 4px auto;
  overflow:hidden;
}
.bar-fill { height:100%; border-radius:4px; }
.bar-fill.pos { background:#38a169; }  /* inflow */
.bar-fill.neg { background:#e53e3e; }  /* outflow */
.bar-fill.neu { background:#a0aec0; }  /* neutral */
.net-label { font-size:11px; color:#718096; }

/* Bias */
.badge { padding:2px 6px; border-radius:6px; font-size:12px; font-weight:600; }
.strong-bull { background:#c6f6d5; color:#22543d; }
.strong-bear { background:#fed7d7; color:#742a2a; }
.mixed { background:#e2e8f0; color:#2d3748; }

.bias-bar {
  display:flex;
  height:6px;
  width:80px;
  border-radius:4px;
  overflow:hidden;
  margin:4px auto;
}
.bias-fii { background:#3182ce; }   /* Blue FII */
.bias-dii { background:#805ad5; }   /* Purple DII */

.bias-tooltip {
  font-size:12px;
  color:#2d3748;
  margin-top:2px;
}
/* Bias Bar */
.bias-bar {
  display:flex;
  height:8px;
  width:100px;
  border-radius:6px;
  overflow:hidden;
  margin-top:4px;
  box-shadow:inset 0 1px 2px rgba(0,0,0,0.15);
}
.bias-fii { background:#3182ce; }   /* Blue for FII */
.bias-dii { background:#805ad5; }   /* Purple for DII */

/* Tooltip (already added, re-confirm) */
.bias-wrapper { position:relative; display:inline-block; }
.bias-tooltip {
  visibility:hidden;
  opacity:0;
  transition:opacity 0.2s ease;
  position:absolute;
  top:120%; left:50%; transform:translateX(-50%);
  background:#2d3748; color:#fff;
  padding:6px 10px;
  border-radius:6px;
  font-size:12px;
  white-space:nowrap;
  z-index:10;
}
.bias-wrapper:hover .bias-tooltip {
  visibility:visible;
  opacity:1;
}
/* News sentiment badges */
.badge-pos {background:#c6f6d5;color:#22543d;font-weight:600;padding:2px 6px;border-radius:6px;}
.badge-neg {background:#fed7d7;color:#742a2a;font-weight:600;padding:2px 6px;border-radius:6px;}
.badge-neu {background:#e2e8f0;color:#2d3748;font-weight:600;padding:2px 6px;border-radius:6px;}
.news-item{margin-bottom:10px;}
.news-headline{font-weight:600;}
.news-content{display:none;margin-left:15px;font-size:14px;color:#444;background:#f9fafb;padding:8px;border-radius:6px;}
.trade-plan li{margin-bottom:4px;}

/* --- Expand Rows --- */

/* --- Modal --- */
.modal { z-index:2000 !important; }
.modal-backdrop { z-index:1500 !important; }
.modal-content {border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.25);}
#summaryModal .modal-header {
  background: linear-gradient(135deg,#7b2ff7,#5a67d8);
  color:white;
}
#summaryModal .modal-body {
  background:#f9fafb;
  max-height:75vh;
  overflow-y:auto;
  font-size:15px;
  line-height:1.6;
}

/* --- Section Headers --- */
.section-header {
  padding:10px 15px;
  font-weight:700;
  color:white;
  border-radius:8px;
  margin-top:15px;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.section-header span.left {
  display:flex;
  align-items:center;
  gap:8px;
}
.quick-summary {background:linear-gradient(135deg, #6366f1, #4f46e5);}
.market-story {background:linear-gradient(135deg, #3b82f6, #06b6d4);}
.trend-warning {background:linear-gradient(135deg, #facc15, #f97316);color:#111;}
.recap {background:linear-gradient(135deg, #7c3aed, #9333ea);}
.news {background:linear-gradient(135deg, #16a34a, #22c55e);}
.intraday {background:linear-gradient(135deg, #f43f5e, #e11d48);}

/* Badges */
.badge-pos {background:#c6f6d5;color:#22543d;}
.badge-neg {background:#fed7d7;color:#742a2a;}
.badge-neu {background:#e2e8f0;color:#2d3748;}
.btn.rounded-circle {
  width: 38px;
  height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.btn.rounded-circle:hover {
  transform: scale(1.12);
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
}
.controls {
  border-radius: 12px;
  transition: all 0.3s ease;
}

.controls .btn {
  font-weight: 600;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.controls .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.controls select {
  min-width: 160px;
  border-radius: 8px;
}



</style>

</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="logo">
      <img src="https://img.icons8.com/color/48/000000/stock-market.png" alt="Logo"/>
      <div class="title">NIFTY Market Tracker</div>
    </div>
  </div>
<!-- Controls -->
<div class="controls d-flex flex-wrap align-items-center gap-3 p-3 rounded shadow-sm bg-white">

  <!-- Filter Form -->
  <form method="get" class="d-flex align-items-center gap-2 flex-grow-1">
    <label class="fw-bold text-secondary me-2">
      <i class="bi bi-funnel"></i> Filter:
    </label>
    <select name="filter" class="form-select form-select-sm w-auto">
      <option value="all" {% if filter_option == 'all' %}selected{% endif %}>All</option>
      <option value="monday" {% if filter_option == 'monday' %}selected{% endif %}>Monday</option>
      <option value="tuesday" {% if filter_option == 'tuesday' %}selected{% endif %}>Tuesday</option>
      <option value="wednesday" {% if filter_option == 'wednesday' %}selected{% endif %}>Wednesday</option>
      <option value="thursday" {% if filter_option == 'thursday' %}selected{% endif %}>Thursday</option>
      <option value="friday" {% if filter_option == 'friday' %}selected{% endif %}>Friday</option>
      <option value="yesterday" {% if filter_option == 'yesterday' %}selected{% endif %}>Yesterday</option>
      <option value="week" {% if filter_option == 'week' %}selected{% endif %}>This Week</option>
      <option value="month" {% if filter_option == 'month' %}selected{% endif %}>This Month</option>
      <option value="3months" {% if filter_option == '3months' %}selected{% endif %}>Last 3 Months</option>
    </select>
    <button type="submit" class="btn btn-sm btn-primary px-3 shadow-sm">
      ‚ö° Apply
    </button>
  </form>

  <!-- Update Form -->
  <form method="post" class="d-inline">{% csrf_token %}
    <button type="submit" name="update_data" 
            class="btn btn-sm btn-success px-3 shadow-sm">
      üîÑ Update
    </button>
  </form>

  <!-- Reset -->
  <button onclick="resetAll()" class="btn btn-sm btn-danger px-3 shadow-sm">
    üóëÔ∏è Reset
  </button>

</div>

<!-- Summary Cards -->
<div class="summary-cards">
  <div class="summary-card bullish">
    üìà Bullish Days: {{ bullish_days }} ({{ bullish_percent }}%)
    <div class="progress">
      <div class="progress-bar bullish" style="width:{{ bullish_percent }}%"></div>
    </div>
  </div>

  <div class="summary-card bearish">
    üìâ Bearish Days: {{ bearish_days }} ({{ bearish_percent }}%)
    <div class="progress">
      <div class="progress-bar bearish" style="width:{{ bearish_percent }}%"></div>
    </div>
  </div>

  <div class="summary-card neutral">
    ‚öñÔ∏è Neutral Days: {{ neutral_days }} ({{ neutral_percent }}%)
    <div class="progress">
      <div class="progress-bar neutral" style="width:{{ neutral_percent }}%"></div>
    </div>
  </div>

  <div class="summary-card total">
    üìä Total Working Days: {{ total_days }}
    <div class="progress">
      <div class="progress-bar total" style="width:100%"></div>
    </div>
  </div>
</div>

 

  <!-- Records Table -->
  <table>
    <thead>
      <tr>
        <th>S.No</th><th>Date</th><th>Open</th><th>Low</th><th>High</th><th>Close</th>
        <th>Points</th><th>Decision</th><th>FII Net</th><th>DII Net</th>
        <th>Bias</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for rec in records %}
      <tr>
        <td>{{ forloop.counter0|add:records.start_index }}</td>
        <td>{{ rec.date|date:"D, M d, Y" }}</td>
        <td>{{ rec.nifty_open }}</td>
        <td>{{ rec.nifty_low }}</td>
        <td>{{ rec.nifty_high }}</td>
        <td>{{ rec.nifty_close }}</td>
        <td class="{% if rec.points >= 0 %}points-positive{% else %}points-negative{% endif %}">
          {% if rec.points >= 0 %}+{% endif %}{{ rec.points }}
        </td>
        <td class="{% if rec.calculated_decision == 'Bullish' %}bullish{% elif rec.calculated_decision == 'Bearish' %}bearish{% else %}neutral{% endif %}">
          {% if rec.calculated_decision == 'Bullish' %}üìà{% elif rec.calculated_decision == 'Bearish' %}üìâ{% else %}‚öñÔ∏è{% endif %} {{ rec.calculated_decision }}
        </td>
      <!-- FII Net -->
<td>
  <div class="net-wrapper">
    <span class="net-value {% if rec.fii_net > 0 %}pos{% elif rec.fii_net < 0 %}neg{% else %}neu{% endif %}">
      {% if rec.fii_net > 0 %}+{% endif %}{{ rec.fii_net }}
    </span>
    <div class="net-bar">
      <div class="bar-fill {% if rec.fii_net > 0 %}pos{% elif rec.fii_net < 0 %}neg{% else %}neu{% endif %}"
           style="width:{{ rec.fii_percent|default:0 }}%"></div>
    </div>
    <small class="net-label">FII Flow</small>
  </div>
</td>

<!-- DII Net -->
<td>
  <div class="net-wrapper">
    <span class="net-value {% if rec.dii_net > 0 %}pos{% elif rec.dii_net < 0 %}neg{% else %}neu{% endif %}">
      {% if rec.dii_net > 0 %}+{% endif %}{{ rec.dii_net }}
    </span>
    <div class="net-bar">
      <div class="bar-fill {% if rec.dii_net > 0 %}pos{% elif rec.dii_net < 0 %}neg{% else %}neu{% endif %}"
           style="width:{{ rec.dii_percent|default:0 }}%"></div>
    </div>
    <small class="net-label">DII Flow</small>
  </div>
</td>
<td>
  <div class="bias-wrapper">
    {% if rec.bias == "Strong Bullish" %}
      <span class="badge strong-bull">üöÄ Strong Bullish</span>
    {% elif rec.bias == "Strong Bearish" %}
      <span class="badge strong-bear">üîª Strong Bearish</span>
    {% elif rec.bias == "FII Bullish" %}
      <span class="badge fii-bull">üìà FII Bullish</span>
    {% elif rec.bias == "DII Bullish" %}
      <span class="badge dii-bull">üìà DII Bullish</span>
    {% else %}
      <span class="badge mixed">‚öñÔ∏è Neutral</span>
    {% endif %}

    <!-- Stacked Bar -->
    <div class="bias-bar">
      <div class="bias-fii" style="width:{{ rec.fii_percent }}%"></div>
      <div class="bias-dii" style="width:{{ rec.dii_percent }}%"></div>
    </div>

    <!-- Tooltip -->
    <div class="bias-tooltip">
      FII: {{ rec.fii_percent }}% | DII: {{ rec.dii_percent }}%
    </div>
  </div>
</td>

         <td>
  <div class="d-flex flex-wrap gap-2 justify-content-center">

    <!-- Summary -->
    <button class="btn btn-sm btn-primary rounded-circle shadow"
            data-bs-toggle="tooltip" data-bs-placement="top" title="Daily Summary"
            onclick="openSummaryModal('{{ rec.date|date:"Y-m-d" }}')">
     
    üìñ</button>

    <!-- Expand -->
    <button class="btn btn-sm btn-info rounded-circle shadow"
            data-bs-toggle="tooltip" data-bs-placement="top" title="Expand FII/DII"
            onclick="event.stopPropagation();toggleExpand('details-{{ rec.id }}')">
     
    üîç</button>

    <!-- Hourly -->
    <button type="button" class="btn btn-sm btn-warning rounded-circle shadow"
            data-bs-toggle="tooltip" data-bs-placement="top" title="Hourly Data"
            onclick="event.stopPropagation();toggleAccordion('hourly-{{ rec.id }}', this)">
     
    ‚è∞</button>

    <!-- 30m -->
    <button type="button" class="btn btn-sm btn-danger rounded-circle shadow"
            data-bs-toggle="tooltip" data-bs-placement="top" title="30-Min Data"
            onclick="event.stopPropagation();toggleAccordion('m30-{{ rec.id }}', this)">
     
    ‚è±Ô∏è</button>
    <!-- 5m -->
<button type="button" class="btn btn-sm btn-secondary rounded-circle shadow"
        data-bs-toggle="tooltip" data-bs-placement="top" title="5-Min Data"
        onclick="event.stopPropagation();toggleAccordion('m5-{{ rec.id }}', this)">
‚è≥</button>

<!-- 2m -->
<button type="button" class="btn btn-sm btn-dark rounded-circle shadow"
        data-bs-toggle="tooltip" data-bs-placement="top" title="2-Min Data"
        onclick="event.stopPropagation();toggleAccordion('m2-{{ rec.id }}', this)">
‚åõ</button>



  </div>
</td>

      </tr>
 <!-- FII/DII Expand -->
      <tr id="details-{{ rec.id }}" class="expand-row" style="display:none;">
        <td colspan="13">
          <table style="width:100%;border-collapse:collapse;margin-top:10px;">
            <thead style="background:#5a67d8;color:#fff;">
              <tr>
                <th>FII Buy</th><th>FII Sell</th><th>FII Net</th>
                <th>DII Buy</th><th>DII Sell</th><th>DII Net</th>
              </tr>
            </thead>
            <tbody>
              <tr style="background:#f8f9fa;">
                <td>{{ rec.fii_buy }}</td>
                <td>{{ rec.fii_sell }}</td>
                <td>{{ rec.fii_net }}</td>
                <td>{{ rec.dii_buy }}</td>
                <td>{{ rec.dii_sell }}</td>
                <td>{{ rec.dii_net }}</td>
              </tr>
            </tbody>
          </table>
        </td>
      </tr>
      <!-- Hourly Accordion -->
<tr id="hourly-{{ rec.id }}" class="accordion-content hourly" style="display:none;">
  <td colspan="13">
    <div class="accordion-header hourly">‚è∞ Hourly Data</div>
    <table class="hourly">
      <thead>
        <tr><th>Hour</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Points</th><th>Decision</th></tr>
      </thead>
      <tbody>
        {% for hr in rec.hourly_set_calculated %}
        <tr>
          <td>{{ hr.hour|time:"H:i" }}</td>
          <td>{{ hr.nifty_open }}</td>
          <td>{{ hr.nifty_high }}</td>
          <td>{{ hr.nifty_low }}</td>
          <td>{{ hr.nifty_close }}</td>
          <td class="{% if hr.points >= 0 %}points-positive{% else %}points-negative{% endif %}">
            {% if hr.points >= 0 %}+{% endif %}{{ hr.points }}
          </td>
          <td class="{% if hr.calculated_decision == 'Bullish' %}bullish{% elif hr.calculated_decision == 'Bearish' %}bearish{% else %}neutral{% endif %}">
            {% if hr.calculated_decision == 'Bullish' %}üìà{% elif hr.calculated_decision == 'Bearish' %}üìâ{% else %}‚öñÔ∏è{% endif %} {{ hr.calculated_decision }}
          </td>
        </tr>
        {% empty %}<tr><td colspan="7">No hourly data</td></tr>{% endfor %}
      </tbody>
    </table>
  </td>
</tr>

      <!-- 30m Accordion -->
      
<!-- 30-Min Accordion -->
<tr id="m30-{{ rec.id }}" class="accordion-content m30" style="display:none;">
  <td colspan="13">
    <div class="accordion-header m30">‚è± 30-Minute Data</div>
    <table class="m30">
      <thead>
        <tr><th>Time</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Points</th><th>Decision</th></tr>
      </thead>
      <tbody>
        {% for m30 in rec.m30_set_calculated %}
        <tr>
          <td>{{ m30.hour|time:"H:i" }}</td>
          <td>{{ m30.nifty_open }}</td>
          <td>{{ m30.nifty_high }}</td>
          <td>{{ m30.nifty_low }}</td>
          <td>{{ m30.nifty_close }}</td>
          <td class="{% if m30.points >= 0 %}points-positive{% else %}points-negative{% endif %}">
            {% if m30.points >= 0 %}+{% endif %}{{ m30.points }}
          </td>
          <td class="{% if m30.calculated_decision == 'Bullish' %}bullish{% elif m30.calculated_decision == 'Bearish' %}bearish{% else %}neutral{% endif %}">
            {% if m30.calculated_decision == 'Bullish' %}üìà{% elif m30.calculated_decision == 'Bearish' %}üìâ{% else %}‚öñÔ∏è{% endif %} {{ m30.calculated_decision }}
          </td>
        </tr>
        {% empty %}<tr><td colspan="7">No 30m data</td></tr>{% endfor %}
      </tbody>
    </table>
  </td>
</tr>
<!-- 5m Accordion -->
<tr id="m5-{{ rec.id }}" class="accordion-content m5" style="display:none;">
  <td colspan="13">
    <div class="accordion-header m5">‚è≥ 5-Minute Data</div>
    <table class="m5">
      <thead>
        <tr><th>Time</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Points</th><th>Decision</th></tr>
      </thead>
      <tbody>
        {% for m5 in rec.m5_set_calculated %}
        <tr>
          <td>{{ m5.hour|time:"H:i" }}</td>
          <td>{{ m5.nifty_open }}</td>
          <td>{{ m5.nifty_high }}</td>
          <td>{{ m5.nifty_low }}</td>
          <td>{{ m5.nifty_close }}</td>
          <td class="{% if m5.points >= 0 %}points-positive{% else %}points-negative{% endif %}">
            {% if m5.points >= 0 %}+{% endif %}{{ m5.points }}
          </td>
          <td class="{% if m5.calculated_decision == 'Bullish' %}bullish{% elif m5.calculated_decision == 'Bearish' %}bearish{% else %}neutral{% endif %}">
            {% if m5.calculated_decision == 'Bullish' %}üìà{% elif m5.calculated_decision == 'Bearish' %}üìâ{% else %}‚öñÔ∏è{% endif %} {{ m5.calculated_decision }}
          </td>
        </tr>
        {% empty %}<tr><td colspan="7">No 5m data</td></tr>{% endfor %}
      </tbody>
    </table>
  </td>
</tr>
<!-- 2m Accordion -->
<tr id="m2-{{ rec.id }}" class="accordion-content m2" style="display:none;">
  <td colspan="13">
    <div class="accordion-header m2">‚åõ 2-Minute Data</div>
    <table class="m2">
      <thead>
        <tr><th>Time</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Points</th><th>Decision</th></tr>
      </thead>
      <tbody>
        {% for m2 in rec.m2_set_calculated %}
        <tr>
          <td>{{ m2.hour|time:"H:i" }}</td>
          <td>{{ m2.nifty_open }}</td>
          <td>{{ m2.nifty_high }}</td>
          <td>{{ m2.nifty_low }}</td>
          <td>{{ m2.nifty_close }}</td>
          <td class="{% if m2.points >= 0 %}points-positive{% else %}points-negative{% endif %}">
            {% if m2.points >= 0 %}+{% endif %}{{ m2.points }}
          </td>
          <td class="{% if m2.calculated_decision == 'Bullish' %}bullish{% elif m2.calculated_decision == 'Bearish' %}bearish{% else %}neutral{% endif %}">
            {% if m2.calculated_decision == 'Bullish' %}üìà{% elif m2.calculated_decision == 'Bearish' %}üìâ{% else %}‚öñÔ∏è{% endif %} {{ m2.calculated_decision }}
          </td>
        </tr>
        {% empty %}<tr><td colspan="7">No 2m data</td></tr>{% endfor %}
      </tbody>
    </table>
  </td>
</tr>


      {% endfor %}
    </tbody>
  </table>

  <!-- Pagination -->
  <div class="pagination">
    {% if records.has_previous %}
      <a href="?page={{ records.previous_page_number }}{% if filter_option %}&filter={{ filter_option }}{% endif %}">¬´ Prev</a>
    {% endif %}
    {% for num in records.paginator.page_range %}
      {% if records.number == num %}
        <span class="current">{{ num }}</span>
      {% elif num > records.number|add:-3 and num < records.number|add:3 %}
        <a href="?page={{ num }}{% if filter_option %}&filter={{ filter_option }}{% endif %}">{{ num }}</a>
      {% endif %}
    {% endfor %}
    {% if records.has_next %}
      <a href="?page={{ records.next_page_number }}{% if filter_option %}&filter={{ filter_option }}{% endif %}">Next ¬ª</a>
    {% endif %}
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Modal -->
<div class="modal fade" id="summaryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      
      <!-- Modal Header -->
      <div class="modal-header text-white" style="background:linear-gradient(135deg,#7b2ff7,#5a67d8);">
        <h5 class="modal-title fw-bold">üìñ Daily Market Summary</h5>
        <div class="ms-auto d-flex gap-2 align-items-center">
          <select id="langSelect" class="form-select form-select-sm bg-light border-0 shadow-sm" onchange="loadSummary()">
            <option value="en">English</option>
            <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
            <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
            <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
            <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
          </select>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body bg-light p-4" style="max-height:75vh;overflow-y:auto;">
        <div id="summaryContent" class="text-muted">‚è≥ Generating summary...</div>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let selectedDate = null;

function openSummaryModal(date) {
  selectedDate = date;
  loadSummary();
  new bootstrap.Modal(document.getElementById('summaryModal')).show();
}

function loadSummary() {
  const lang = document.getElementById("langSelect").value;
  document.getElementById("summaryContent").innerHTML = "‚è≥ Generating summary...";
  fetch(`/marketdata/summary_api?date=${selectedDate}&lang=${lang}`)
    .then(res => res.json())
    .then(data => renderSummary(data))
    .catch(err => {
      console.error(err);
      document.getElementById("summaryContent").innerHTML = "‚ö† Failed to load summary";
    });
}

function renderSummary(data) {
  let html = "";

  // Quick Summary
  if (data.summary_lines?.length) {
    const recapLine = data.summary_lines[1];
    const openVal = parseFloat(recapLine.match(/opened (\d+\.?\d*)/)[1]);
    const highVal = parseFloat(recapLine.match(/High (\d+\.?\d*)/)[1]);
    const lowVal = parseFloat(recapLine.match(/Low (\d+\.?\d*)/)[1]);
    const closeVal = parseFloat(recapLine.match(/Close (\d+\.?\d*)/)[1]);
    const pctChange = (((closeVal - openVal) / openVal) * 100).toFixed(2);

    html += `
    <div class="section-header quick-summary"><span class="left">üìã Quick Summary</span></div>
    <div class="p-3 bg-white rounded shadow-sm mb-3">
      <b>Date:</b> ${data.summary_lines[0]}<br/>
      <b>Open:</b> ${openVal}, <b>High:</b> ${highVal}, <b>Low:</b> ${lowVal}, <b>Close:</b> ${closeVal}<br/>
      <b>Bias:</b> ${data.bias}, <b>PCR:</b> ${data.flows.pcr}, <b>% Chg:</b> ${pctChange}%
    </div>`;
  }

  // Market Story
  if (data.narrative) {
    html += `<div class="section-header market-story"><span class="left">üìò Market Story</span></div>
    <div class="p-3 bg-white rounded shadow-sm mb-3">${data.narrative}</div>`;
  }

  // Trend Warning
  if (data.trend_warning) {
    html += `<div class="section-header trend-warning"><span class="left">‚ö†Ô∏è Trend Alert</span></div>
    <div class="p-3 bg-white rounded shadow-sm mb-3">${data.trend_warning}</div>`;
  }

  // Recap
  let bull = data.summary_lines.filter(l=>l.includes("Bullish")).length;
  let bear = data.summary_lines.filter(l=>l.includes("Bearish")).length;
  let neu = data.summary_lines.filter(l=>l.includes("Neutral")).length;
  html += `<div class="section-header recap">
      <span class="left">üìä Recap</span>
      <span>
        <span class="badge badge-pos">${bull} Bullish</span>
        <span class="badge badge-neg">${bear} Bearish</span>
        <span class="badge badge-neu">${neu} Neutral</span>
      </span>
    </div><div class="p-3 bg-white rounded shadow-sm mb-3"><ul>`;
  data.summary_lines.forEach(line => html += `<li>${line}</li>`);
  html += `</ul></div>`;

  // News
  if (data.news?.length) {
    let pos = data.news.filter(n=>n.sentiment==="Positive").length;
    let neg = data.news.filter(n=>n.sentiment==="Negative").length;
    let neuNews = data.news.filter(n=>n.sentiment==="Neutral").length;
    html += `<div class="section-header news">
      <span class="left">üì∞ Key News</span>
      <span>
        <span class="badge badge-pos">${pos} üü¢</span>
        <span class="badge badge-neg">${neg} üî¥</span>
        <span class="badge badge-neu">${neuNews} ‚ö™</span>
      </span>
    </div><div class="p-3 bg-white rounded shadow-sm mb-3"><ul>`;
    data.news.forEach(n => {
      let emoji = n.sentiment==="Positive"?"üü¢":n.sentiment==="Negative"?"üî¥":"‚ö™";
      html += `<li>${emoji} ${n.title} <small class="text-muted">(${n.source})</small></li>`;
    });
    html += `</ul></div>`;
  }

  // Intraday
  if (data.intraday_traps?.length) {
    html += `<div class="section-header intraday"><span class="left">üïí Intraday Timeline</span></div>
      <div class="p-3 bg-white rounded shadow-sm mb-3">
      <table class="table table-sm table-striped">
        <thead><tr><th>Time</th><th>Move</th><th>Note</th></tr></thead><tbody>`;
    data.intraday_traps.forEach(s => {
      let c = s.direction==="up"?"text-success":"text-danger";
      html += `<tr><td>${s.time}</td><td class="${c}">${s.points}</td><td>${s.annotation}</td></tr>`;
    });
    html += `</tbody></table></div>`;
  }

  document.getElementById("summaryContent").innerHTML = html;
}

function resetAll(){ window.location.href="{% url 'record_list' %}"; }
function toggleExpand(id){
  const row = document.getElementById(id);
  row.style.display = row.style.display === "table-row" ? "none" : "table-row";
}

function toggleAccordion(id, btn){
  const target = document.getElementById(id);
  if(target.style.display==="table-row"){ 
    target.style.display="none"; 
    btn.classList.remove("active"); 
  } else {
    document.querySelectorAll(".accordion-content").forEach(r=>r.style.display="none");
    document.querySelectorAll(".btn-toggle").forEach(b=>b.classList.remove("active"));
    target.style.display="table-row";
    btn.classList.add("active");
  }
}
document.addEventListener("DOMContentLoaded", function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  });


</script>
</body>
</html>
