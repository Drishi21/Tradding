{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NIFTY Market Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* --- Reset & Base --- */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:#f4f6f8;color:#333;}
.container{max-width:1400px;margin:auto;padding:15px;}

/* --- Header --- */
.header{display:flex;align-items:center;justify-content:space-between;
  background:#fff;padding:15px 25px;border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-bottom:20px;}
.header .logo{display:flex;align-items:center;}
.header .logo img{width:40px;height:40px;margin-right:12px;}
.header .title{font-size:1.6rem;font-weight:700;color:#2c3e50;}

/* --- Controls --- */
.controls{display:flex;flex-wrap:wrap;gap:15px;align-items:center;
  background:#fff;padding:20px;border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,0.05);margin-bottom:25px;}
.controls select,.controls button{padding:10px 16px;border:1px solid #ccc;border-radius:8px;
  font-size:14px;cursor:pointer;}
.controls .btn-submit{background:#5a67d8;color:white;border:none;}
.controls .btn-update{background:#38a169;color:white;border:none;}
.controls .btn-reset{background:#e53e3e;color:white;border:none;}

/* --- Summary Cards --- */
.summary-cards{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:25px;}
.summary-card{flex:1 1 200px;background:#fff;border-radius:12px;
  padding:15px;box-shadow:0 4px 10px rgba(0,0,0,0.05);
  text-align:center;font-weight:600;font-size:14px;}
.summary-card.bullish{border:2px solid #38a169;color:#38a169;}
.summary-card.bearish{border:2px solid #e53e3e;color:#e53e3e;}
.summary-card.neutral{border:2px solid #718096;color:#2d3748;}
.progress{width:100%;background:#edf2f7;border-radius:8px;height:8px;margin-top:8px;overflow:hidden;}
.progress-bar{height:100%;border-radius:8px;}
.progress-bar.bullish{background:#38a169;}
.progress-bar.bearish{background:#e53e3e;}
.progress-bar.neutral{background:#718096;}

/* --- Prediction Cards --- */
.prediction-card {
  padding:15px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  margin-bottom:20px;
  text-align:center;
  font-weight:600;
}
.prediction-card.bullish { border:2px solid #38a169; color:#38a169; }
.prediction-card.bearish { border:2px solid #e53e3e; color:#e53e3e; }
.prediction-card.neutral { border:2px solid #718096; color:#718096; }

/* --- Table --- */
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;
  box-shadow:0 4px 20px rgba(0,0,0,0.05);margin-bottom:20px;}
thead{background:linear-gradient(135deg,#5a67d8,#7b2ff7);color:#fff;}
th,td{padding:10px;text-align:center;font-size:14px;}
tr:nth-child(even){background:#f8f9fa;}
tr:hover{background:#edf2ff;}
.points-positive{color:#38a169;font-weight:bold;}
.points-negative{color:#e53e3e;font-weight:bold;}
.bullish{color:#38a169;font-weight:bold;}
.bearish{color:#e53e3e;font-weight:bold;}
.neutral{color:#718096;font-weight:bold;}

/* --- Accordion Buttons --- */
.btn-toggle {
  background:#f3f4f6;
  border:1px solid #ccc;
  border-radius:6px;
  padding:4px 10px;
  font-size:13px;
  cursor:pointer;
  transition:all 0.2s ease;
}
.btn-toggle:hover { background:#e2e8f0; }
.btn-toggle.active {
  background:linear-gradient(135deg,#7b2ff7,#5a67d8);
  color:white;font-weight:600;border:none;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
}

/* --- Accordion Content --- */
.accordion-content{display:none;background:#f9fafb;}
.accordion-content.active{display:table-row-group;}
.accordion-header{font-weight:700;padding:10px;color:#fff;}
.accordion-header.hourly{background:linear-gradient(135deg,#5a67d8,#7b2ff7);}
.accordion-header.m30{background:linear-gradient(135deg,#38a169,#2f855a);}
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="logo">
      <img src="https://img.icons8.com/color/48/000000/stock-market.png" alt="Logo"/>
      <div class="title">NIFTY Market Tracker</div>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <form method="get" style="display:flex;gap:10px;">
       <select name="filter">
        <option value="all" {% if filter_option == 'all' %}selected{% endif %}>All</option>
        <option value="today" {% if filter_option == 'today' %}selected{% endif %}>Today</option>
        <option value="yesterday" {% if filter_option == 'yesterday' %}selected{% endif %}>Yesterday</option>
        <option value="week" {% if filter_option == 'week' %}selected{% endif %}>This Week</option>
        <option value="month" {% if filter_option == 'month' %}selected{% endif %}>This Month</option>
        <option value="3months" {% if filter_option == '3months' %}selected{% endif %}>Last 3 Months</option>
      </select>
      <button type="submit" class="btn-submit">‚ö° Apply</button>
    </form>
    <form method="post">{% csrf_token %}
      <button type="submit" name="update_data" class="btn-update">üîÑ Update</button>
    </form>
    <button onclick="resetAll()" class="btn-reset">üóëÔ∏è Reset</button>
  </div>

  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="summary-card bullish">üìà Bullish Days: {{ bullish_percent }}%
      <div class="progress"><div class="progress-bar bullish" style="width:{{ bullish_percent }}%"></div></div>
    </div>
    <div class="summary-card bearish">üìâ Bearish Days: {{ bearish_percent }}%
      <div class="progress"><div class="progress-bar bearish" style="width:{{ bearish_percent }}%"></div></div>
    </div>
    <div class="summary-card neutral">‚öñÔ∏è Neutral Days: {{ neutral_percent }}%
      <div class="progress"><div class="progress-bar neutral" style="width:{{ neutral_percent }}%"></div></div>
    </div>
  </div>

  <!-- üî• Live Prediction -->
  <h3>üî• Live Prediction</h3>
  <div class="prediction-card {% if prediction.trend == 'Bullish' %}bullish{% elif prediction.trend == 'Bearish' %}bearish{% else %}neutral{% endif %}">
    {{ prediction.trend }} | {{ prediction.trade }} | Strike: {{ prediction.strike }}<br>
    üí∞ Entry: {{ prediction.entry }} | üéØ Target: {{ prediction.target }} | üõë SL: {{ prediction.stoploss }}<br>
    üì¶ Lots: {{ prediction.lots }} | üìä Result: {{ prediction.result }}
  </div>

  <!-- üìà Charts -->
  <h3>üìà Prediction Accuracy Over Time</h3>
  <canvas id="accuracyChart" height="80"></canvas>

  <h3>üìä Profit vs Loss Count</h3>
  <canvas id="resultChart" height="80"></canvas>

  <!-- Past Predictions -->
  <h3>üìä Past Predictions (30 Minutes)</h3>
  <table>
    <thead><tr><th>Time</th><th>Trend</th><th>Strike</th><th>Entry</th><th>Target</th><th>Stoploss</th><th>Result</th></tr></thead>
    <tbody>
      {% for p in past_predictions_30m %}
      <tr>
        <td>{{ p.timestamp|date:"D H:i" }}</td>
        <td>{{ p.predicted_trend }}</td>
        <td>{{ p.strike }}</td>
        <td>{{ p.entry }}</td>
        <td>{{ p.target }}</td>
        <td>{{ p.stoploss }}</td>
        <td>{% if p.result == "Profit" %}‚úÖ{% elif p.result == "Loss" %}‚ùå{% else %}‚è≥{% endif %} {{ p.result }}</td>
      </tr>
      {% empty %}<tr><td colspan="7">No predictions yet</td></tr>{% endfor %}
    </tbody>
  </table>

  <!-- Records Table -->
  <h3>üìã Market Records</h3>
  <table>
    <thead>
      <tr>
        <th>S.No</th><th>Date</th><th>Open</th><th>Low</th><th>High</th><th>Close</th>
        <th>Points</th><th>Decision</th><th>FII Net</th><th>DII Net</th><th>PCR</th>
      </tr>
    </thead>
    <tbody>
      {% for rec in records %}
      <tr>
        <td>{{ forloop.counter0|add:records.start_index }}</td>
        <td>{{ rec.date|date:"D, M d, Y" }}</td>
        <td>{{ rec.nifty_open }}</td>
        <td>{{ rec.nifty_low }}</td>
        <td>{{ rec.nifty_high }}</td>
        <td>{{ rec.nifty_close }}</td>
        <td class="{% if rec.points >= 0 %}points-positive{% else %}points-negative{% endif %}">
          {% if rec.points >= 0 %}+{% endif %}{{ rec.points }}
        </td>
        <td class="{% if rec.calculated_decision == 'Bullish' %}bullish{% elif rec.calculated_decision == 'Bearish' %}bearish{% else %}neutral{% endif %}">
          {{ rec.calculated_decision }}
        </td>
        <td>{{ rec.fii_net }}</td>
        <td>{{ rec.dii_net }}</td>
        <td>{{ rec.pcr }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
function resetAll(){ window.location.href="{% url 'record_list' %}"; }

// === Charts ===
const labels = {{ chart_labels|safe }};
const accuracy = {{ chart_accuracy|safe }};
const wins = {{ chart_wins|safe }};
const losses = {{ chart_losses|safe }};

// Accuracy Line Chart
new Chart(document.getElementById("accuracyChart"), {
  type: 'line',
  data: {
    labels: labels,
    datasets: [{
      label: "Accuracy (%)",
      data: accuracy,
      borderColor: "#38a169",
      backgroundColor: "rgba(56,161,105,0.2)",
      tension: 0.3,
      fill: true
    }]
  },
  options: {
    responsive: true,
    scales: {
      y: { min: 0, max: 100, title: { display: true, text: "Accuracy (%)" } }
    }
  }
});

// Profit vs Loss Bar Chart
new Chart(document.getElementById("resultChart"), {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [
      { label: "Wins", data: wins, backgroundColor: "#38a169" },
      { label: "Losses", data: losses, backgroundColor: "#e53e3e" }
    ]
  },
  options: {
    responsive: true,
    scales: { y: { beginAtZero: true, title: { display: true, text: "Count" } } }
  }
});
</script>
</body>
</html>
