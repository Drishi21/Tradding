{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
{% comment %} <title>NIFTY Market Tracker</title> {% endcomment %}
<title>{{ index }} Market Tracker</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">


<style>
/* --- Reset & Base --- */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:#f4f6f8;color:#333;}
.container{max-width:1400px;margin:auto;padding:15px;}

/* --- Header --- */
.header{display:flex;align-items:center;justify-content:space-between;
  background:#fff;padding:15px 25px;border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-bottom:20px;}
.header .logo{display:flex;align-items:center;}
.header .logo img{width:40px;height:40px;margin-right:12px;}
.header .title{font-size:1.6rem;font-weight:700;color:#2c3e50;}

/* --- Controls --- */
.controls{display:flex;flex-wrap:wrap;gap:15px;align-items:center;
  background:#fff;padding:20px;border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,0.05);margin-bottom:25px;}
.controls select,.controls button{padding:10px 16px;border:1px solid #ccc;border-radius:8px;
  font-size:14px;cursor:pointer;}
.controls .btn-submit{background:#5a67d8;color:white;border:none;}
.controls .btn-update{background:#38a169;color:white;border:none;}
.controls .btn-reset{background:#e53e3e;color:white;border:none;}

/* --- Summary Cards --- */
.summary-cards{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:25px;}
.summary-card{flex:1 1 200px;background:#fff;border-radius:12px;
  padding:15px;box-shadow:0 4px 10px rgba(0,0,0,0.05);
  text-align:center;font-weight:600;font-size:14px;}
.summary-card.bullish{border:2px solid #38a169;color:#38a169;}
.summary-card.bearish{border:2px solid #e53e3e;color:#e53e3e;}
.summary-card.neutral{border:2px solid #718096;color:#2d3748;}
.progress{width:100%;background:#edf2f7;border-radius:8px;height:8px;margin-top:8px;overflow:hidden;}
.progress-bar{height:100%;border-radius:8px;}
.progress-bar.bullish{background:#38a169;}
.progress-bar.bearish{background:#e53e3e;}
.progress-bar.neutral{background:#718096;}

/* --- Trade Snippets styled like Summary --- */
.snippets-wrapper{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:30px;}
.snippet{flex:1 1 200px;background:#fff;border-radius:12px;padding:15px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);text-align:center;
  font-weight:600;font-size:14px;}
.snippet.bullish{border:2px solid #38a169;color:#38a169;}
.snippet.bearish{border:2px solid #e53e3e;color:#e53e3e;}
.snippet .day-label{font-size:0.85rem;margin-bottom:6px;}
.snippet .trend{font-size:1.1rem;margin-bottom:4px;}
.snippet .trade{font-weight:500;}

/* --- Table --- */
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;
  box-shadow:0 4px 20px rgba(0,0,0,0.05);margin-bottom:20px;}
thead{background:linear-gradient(135deg,#5a67d8,#7b2ff7);color:#fff;}
th,td{padding:10px;text-align:center;font-size:14px;}
tr:nth-child(even){background:#f8f9fa;}
tr:hover{background:#edf2ff;}
.points-positive{color:#38a169;font-weight:bold;}
.points-negative{color:#e53e3e;font-weight:bold;}
.bullish{color:#38a169;font-weight:bold;}
.bearish{color:#e53e3e;font-weight:bold;}
.neutral{color:#718096;font-weight:bold;}

/* --- Accordion Buttons --- */
.btn-toggle {
  background:#f3f4f6;
  border:1px solid #ccc;
  border-radius:6px;
  padding:4px 10px;
  font-size:13px;
  cursor:pointer;
  transition:all 0.2s ease;
}
.btn-toggle:hover { background:#e2e8f0; }
.btn-toggle.active {
  background:linear-gradient(135deg,#7b2ff7,#5a67d8);
  color:white;font-weight:600;border:none;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
}

/* --- Accordion Content --- */
.accordion-content{display:none;background:#f9fafb;}
.accordion-content.active{display:table-row-group;}

/* Accordion Headers */
.accordion-header{
  text-align:left;font-weight:700;padding:10px;
  border-radius:8px 8px 0 0;color:#fff;margin-bottom:5px;
}
.accordion-header.hourly{background:linear-gradient(135deg,#5a67d8,#7b2ff7);}
.accordion-header.m30{background:linear-gradient(135deg,#38a169,#2f855a);}
.accordion-header.m5{background:linear-gradient(135deg,#38a169,#2f855a);}
.accordion-header.m2{background:linear-gradient(135deg,#38a169,#2f855a);}

/* Accordion Tables */
.accordion-content table{width:100%;border-collapse:collapse;margin-top:8px;
  border-radius:8px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.accordion-content th{font-size:13px;font-weight:600;padding:8px;text-align:center;color:#fff;}
.accordion-content.hourly th{background:linear-gradient(135deg,#5a67d8,#7b2ff7);}
.accordion-content.m30 th{background:linear-gradient(135deg,#38a169,#2f855a);}
.accordion-content td{padding:8px;text-align:center;font-size:13px;}
.accordion-content.hourly tr:nth-child(even){background:#f0f2ff;} /* light purple */
.accordion-content.m30 tr:nth-child(even){background:#e6f9f0;}  /* light green */
.accordion-content tr:hover{background:#e9f0ff;}
.accordion-content .points-positive{color:#38a169;font-weight:600;}
.accordion-content .points-negative{color:#e53e3e;font-weight:600;}
/* Net Wrapper */
.net-wrapper { text-align:center; }
.net-value { font-weight:600; display:block; margin-bottom:2px; }
.net-value.pos { color:#38a169; }   /* Green */
.net-value.neg { color:#e53e3e; }   /* Red */
.net-value.neu { color:#718096; }   /* Gray */

.net-bar {
  width:80px; height:6px;
  background:#edf2f7;
  border-radius:4px;
  margin:0 auto 4px auto;
  overflow:hidden;
}
.bar-fill { height:100%; border-radius:4px; }
.bar-fill.pos { background:#38a169; }  /* inflow */
.bar-fill.neg { background:#e53e3e; }  /* outflow */
.bar-fill.neu { background:#a0aec0; }  /* neutral */
.net-label { font-size:11px; color:#718096; }

/* Bias */
.badge { padding:2px 6px; border-radius:6px; font-size:12px; font-weight:600; }
.strong-bull { background:#c6f6d5; color:#22543d; }
.strong-bear { background:#fed7d7; color:#742a2a; }
.mixed { background:#e2e8f0; color:#2d3748; }

.bias-bar {
  display:flex;
  height:6px;
  width:80px;
  border-radius:4px;
  overflow:hidden;
  margin:4px auto;
}
.bias-fii { background:#3182ce; }   /* Blue FII */
.bias-dii { background:#805ad5; }   /* Purple DII */

.bias-tooltip {
  font-size:12px;
  color:#2d3748;
  margin-top:2px;
}
/* Bias Bar */
.bias-bar {
  display:flex;
  height:8px;
  width:100px;
  border-radius:6px;
  overflow:hidden;
  margin-top:4px;
  box-shadow:inset 0 1px 2px rgba(0,0,0,0.15);
}
.bias-fii { background:#3182ce; }   /* Blue for FII */
.bias-dii { background:#805ad5; }   /* Purple for DII */

/* Tooltip (already added, re-confirm) */
.bias-wrapper { position:relative; display:inline-block; }
.bias-tooltip {
  visibility:hidden;
  opacity:0;
  transition:opacity 0.2s ease;
  position:absolute;
  top:120%; left:50%; transform:translateX(-50%);
  background:#2d3748; color:#fff;
  padding:6px 10px;
  border-radius:6px;
  font-size:12px;
  white-space:nowrap;
  z-index:10;
}
.bias-wrapper:hover .bias-tooltip {
  visibility:visible;
  opacity:1;
}
/* News sentiment badges */
.badge-pos {background:#c6f6d5;color:#22543d;font-weight:600;padding:2px 6px;border-radius:6px;}
.badge-neg {background:#fed7d7;color:#742a2a;font-weight:600;padding:2px 6px;border-radius:6px;}
.badge-neu {background:#e2e8f0;color:#2d3748;font-weight:600;padding:2px 6px;border-radius:6px;}
.news-item{margin-bottom:10px;}
.news-headline{font-weight:600;}
.news-content{display:none;margin-left:15px;font-size:14px;color:#444;background:#f9fafb;padding:8px;border-radius:6px;}
.trade-plan li{margin-bottom:4px;}

/* --- Expand Rows --- */

/* --- Modal --- */
.modal { z-index:2000 !important; }
.modal-backdrop { z-index:1500 !important; }
.modal-content {border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.25);}
#summaryModal .modal-header {
  background: linear-gradient(135deg,#7b2ff7,#5a67d8);
  color:white;
}
#summaryModal .modal-body {
  background:#f9fafb;
  max-height:75vh;
  overflow-y:auto;
  font-size:15px;
  line-height:1.6;
}

/* --- Section Headers --- */
.section-header {
  padding:10px 15px;
  font-weight:700;
  color:white;
  border-radius:8px;
  margin-top:15px;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.section-header span.left {
  display:flex;
  align-items:center;
  gap:8px;
}
.quick-summary {background:linear-gradient(135deg, #6366f1, #4f46e5);}
.market-story {background:linear-gradient(135deg, #3b82f6, #06b6d4);}
.trend-warning {background:linear-gradient(135deg, #facc15, #f97316);color:#111;}
.recap {background:linear-gradient(135deg, #7c3aed, #9333ea);}
.news {background:linear-gradient(135deg, #16a34a, #22c55e);}
.intraday {background:linear-gradient(135deg, #f43f5e, #e11d48);}

/* Badges */
.badge-pos {background:#c6f6d5;color:#22543d;}
.badge-neg {background:#fed7d7;color:#742a2a;}
.badge-neu {background:#e2e8f0;color:#2d3748;}
.btn.rounded-circle {
  width: 38px;
  height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.btn.rounded-circle:hover {
  transform: scale(1.12);
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
}
.controls {
  border-radius: 12px;
  transition: all 0.3s ease;
}

.controls .btn {
  font-weight: 600;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.controls .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.controls select {
  min-width: 160px;
  border-radius: 8px;
}

/* --- Pagination --- */
.pagination {
  text-align: center;
  margin-top: 20px;
}
.pagination a, .pagination span {
  display: inline-block;
  margin: 0 5px;
  padding: 8px 14px;
  border-radius: 8px;
  text-decoration: none;
  color: #5a67d8;
  font-weight: 600;
}
.pagination a:hover {
  background: #5a67d8;
  color: white;
}
.pagination .current {
  background: #5a67d8;
  color: white;
}

/* Accordion Wrapper Animation */
.accordion-wrapper {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease, opacity 0.3s ease;
  opacity: 0;
}
.accordion-wrapper.open {
  max-height: 600px; /* enough space for rows */
  opacity: 1;
}

/* Accordion Body Scroll Area */
.accordion-body {
  max-height: 400px;
  overflow-y: auto;
  border-radius: 8px;
  background: #fff;
  position: relative;
  --header-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

/* Sticky Header Row */
.accordion-body table thead {
  position: sticky;
  top: 0;
  z-index: 5;
}
.accordion-body table thead th {
  color: #fff;
  font-weight: 600;
  box-shadow: var(--header-shadow);
  transition: box-shadow 0.25s ease-in-out;
}

/* Fade Effects */
.accordion-body::before,
.accordion-body::after {
  content: "";
  position: absolute;
  left: 0; right: 0;
  height: 20px;
  opacity: 0;
  pointer-events: none;
  z-index: 6;
  transition: opacity 0.25s ease-in-out, transform 0.25s ease-in-out;
}

/* Top Fade */
.accordion-body::before {
  top: 0;
  background: linear-gradient(to bottom, rgba(0,0,0,0.08), transparent);
  border-radius: 8px 8px 0 0;
}
.accordion-body.has-top-fade::before { opacity: 1; }

/* Bottom Fade */
.accordion-body::after {
  bottom: 0;
  background: linear-gradient(to top, rgba(0,0,0,0.08), transparent);
  border-radius: 0 0 8px 8px;
  transform: translateY(8px);
}
.accordion-body.has-bottom-fade::after {
  opacity: 1;
  transform: translateY(0);
}

/* Interval-specific Header Colors */
.accordion-content.hourly thead th {
  background: linear-gradient(135deg,#5a67d8,#7b2ff7); /* purple */
}
.accordion-content.m30 thead th {
  background: linear-gradient(135deg,#38a169,#2f855a); /* green */
}
.accordion-content.m5 thead th {
  background: linear-gradient(135deg,#f59e0b,#d97706); /* orange */
}
.accordion-content.m2 thead th {
  background: linear-gradient(135deg,#ef4444,#dc2626); /* red */
}

/* Accordion Toggle Buttons (rotation animation) */
.btn-toggle {
  transition: transform 0.3s ease;
}
.btn-toggle.active {
  transform: rotate(90deg);
}



</style>

</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="logo">
      <img src="https://img.icons8.com/color/48/000000/stock-market.png" alt="Logo"/>
      {% comment %} <div class="title">NIFTY Market Tracker</div> {% endcomment %}
      <div class="title">{{ index }} Market Tracker</div>
    </div>
      <!-- Index Toggle -->
    <div class="d-flex gap-2">
      <a href="{% url 'nifty_list' %}" class="btn {% if index == 'NIFTY' %}btn-primary{% else %}btn-outline-primary{% endif %}">
        NIFTY
      </a>
      <a href="{% url 'sensex_list' %}" class="btn {% if index == 'SENSEX' %}btn-success{% else %}btn-outline-success{% endif %}">
        SENSEX
      </a>
       <a href="{% url 'banknifty_list' %}" class="btn {% if index == 'SENSEX' %}btn-warning{% else %}btn-outline-success{% endif %}">
        Bank Nifty
      </a>
    </div>
  </div>
  <a href="{% url 'trade_dashboard' %}" 
   class="btn btn-primary" 
   style="position: fixed; bottom: 20px; right: 20px; z-index: 999;">
   📊 Trade Dashboard
</a>

<!-- Controls -->
<div class="controls d-flex flex-wrap align-items-center gap-3 p-3 rounded shadow-sm bg-white">

  <!-- Filter Form -->
  <form method="get" class="d-flex align-items-center gap-2 flex-grow-1">
    <label class="fw-bold text-secondary me-2">
      <i class="bi bi-funnel"></i> Filter:
    </label>
    <select name="filter" class="form-select form-select-sm w-auto">
      <option value="all" {% if filter_option == 'all' %}selected{% endif %}>All</option>
      <option value="bullish" {% if trend_filter == 'bullish' %}selected{% endif %}>Bullish</option>
    <option value="bearish" {% if trend_filter == 'bearish' %}selected{% endif %}>Bearish</option>
    <option value="neutral" {% if trend_filter == 'neutral' %}selected{% endif %}>Neutral</option>
      <option value="monday" {% if filter_option == 'monday' %}selected{% endif %}>Monday</option>
      <option value="tuesday" {% if filter_option == 'tuesday' %}selected{% endif %}>Tuesday</option>
      <option value="wednesday" {% if filter_option == 'wednesday' %}selected{% endif %}>Wednesday</option>
      <option value="thursday" {% if filter_option == 'thursday' %}selected{% endif %}>Thursday</option>
      <option value="friday" {% if filter_option == 'friday' %}selected{% endif %}>Friday</option>
      <option value="month" {% if filter_option == 'month' %}selected{% endif %}>This Month</option>
      <option value="3months" {% if filter_option == '3months' %}selected{% endif %}>Last 3 Months</option>
    </select>
    <button type="submit" class="btn btn-sm btn-primary px-3 shadow-sm">
      ⚡ Apply
    </button>
  </form>

  <!-- Update Form -->
  <form method="post" class="d-inline">{% csrf_token %}
    <button type="submit" name="update_data" 
            class="btn btn-sm btn-success px-3 shadow-sm">
      🔄 Update
    </button>
  </form>

  <!-- Reset -->
  <button onclick="resetAll()" class="btn btn-sm btn-danger px-3 shadow-sm">
    🗑️ Reset
  </button>

</div>

<!-- Summary Cards -->
<div class="summary-cards">
  <div class="summary-card bullish">
    📈 Bullish Days: {{ bullish_days }} ({{ bullish_percent }}%)
    <div class="progress">
      <div class="progress-bar bullish" style="width:{{ bullish_percent }}%"></div>
    </div>
  </div>

  <div class="summary-card bearish">
    📉 Bearish Days: {{ bearish_days }} ({{ bearish_percent }}%)
    <div class="progress">
      <div class="progress-bar bearish" style="width:{{ bearish_percent }}%"></div>
    </div>
  </div>

  <div class="summary-card neutral">
    ⚖️ Neutral Days: {{ neutral_days }} ({{ neutral_percent }}%)
    <div class="progress">
      <div class="progress-bar neutral" style="width:{{ neutral_percent }}%"></div>
    </div>
  </div>

  <div class="summary-card total">
    📊 Total Working Days: {{ total_days }}
    <div class="progress">
      <div class="progress-bar total" style="width:100%"></div>
    </div>
  </div>
</div>

 

  <!-- Records Table -->
  <table>
    <thead>
      <tr>
        <th>S.No</th><th>Date</th><th>Open</th><th>Low</th><th>High</th><th>Close</th>
        <th>Points</th><th>Decision</th><th>FII Net</th><th>DII Net</th>
        <th>Bias</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for rec in records %}
      <tr>
        <td>{{ forloop.counter0|add:records.start_index }}</td>
        <td>{{ rec.date|date:"D, M d, Y" }}</td>
        <td>{{ rec.nifty_open }}</td>
        <td>{{ rec.nifty_low }}</td>
        <td>{{ rec.nifty_high }}</td>
        <td>{{ rec.close }}</td>  
        <td class="{% if rec.points >= 0 %}points-positive{% else %}points-negative{% endif %}">
          {% if rec.points >= 0 %}+{% endif %}{{ rec.points }}
        </td>
        <td class="{% if rec.final_decision == 'Bullish' %}bullish{% elif rec.final_decision == 'Bearish' %}bearish{% else %}neutral{% endif %}">
          {% if rec.final_decision == 'Bullish' %}📈{% elif rec.final_decision == 'Bearish' %}📉{% else %}⚖️{% endif %} {{ rec.final_decision }}
        </td>
      <!-- FII Net -->
<td>
  <div class="net-wrapper">
    <span class="net-value {% if rec.fii_net > 0 %}pos{% elif rec.fii_net < 0 %}neg{% else %}neu{% endif %}">
      {% if rec.fii_net > 0 %}+{% endif %}{{ rec.fii_net }}
    </span>
    <div class="net-bar">
      <div class="bar-fill {% if rec.fii_net > 0 %}pos{% elif rec.fii_net < 0 %}neg{% else %}neu{% endif %}"
           style="width:{{ rec.fii_percent|default:0 }}%"></div>
    </div>
    <small class="net-label">FII Flow</small>
  </div>
</td>

<!-- DII Net -->
<td>
  <div class="net-wrapper">
    <span class="net-value {% if rec.dii_net > 0 %}pos{% elif rec.dii_net < 0 %}neg{% else %}neu{% endif %}">
      {% if rec.dii_net > 0 %}+{% endif %}{{ rec.dii_net }}
    </span>
    <div class="net-bar">
      <div class="bar-fill {% if rec.dii_net > 0 %}pos{% elif rec.dii_net < 0 %}neg{% else %}neu{% endif %}"
           style="width:{{ rec.dii_percent|default:0 }}%"></div>
    </div>
    <small class="net-label">DII Flow</small>
  </div>
</td>
<td>
  <div class="bias-wrapper">
    {% if rec.bias == "Strong Bullish" %}
      <span class="badge strong-bull">🚀 Strong Bullish</span>
    {% elif rec.bias == "Strong Bearish" %}
      <span class="badge strong-bear">🔻 Strong Bearish</span>
    {% elif rec.bias == "FII Bullish" %}
      <span class="badge fii-bull">📈 FII Bullish</span>
    {% elif rec.bias == "DII Bullish" %}
      <span class="badge dii-bull">📈 DII Bullish</span>
    {% else %}
      <span class="badge mixed">⚖️ Neutral</span>
    {% endif %}

    <!-- Stacked Bar -->
    <div class="bias-bar">
      <div class="bias-fii" style="width:{{ rec.fii_percent }}%"></div>
      <div class="bias-dii" style="width:{{ rec.dii_percent }}%"></div>
    </div>

    <!-- Tooltip -->
    <div class="bias-tooltip">
      FII: {{ rec.fii_percent }}% | DII: {{ rec.dii_percent }}%
    </div>
  </div>
</td>

         <td>
  <div class="d-flex flex-wrap gap-2 justify-content-center">

    <!-- Summary -->
    <button class="btn btn-sm btn-primary rounded-circle shadow"
            data-bs-toggle="tooltip" data-bs-placement="top" title="Daily Summary"
            onclick="openSummaryModal('{{ rec.date|date:"Y-m-d" }}')">
     
    📖</button>

    <!-- Expand -->
    <button class="btn btn-sm btn-info rounded-circle shadow"
            data-bs-toggle="tooltip" data-bs-placement="top" title="Expand FII/DII"
            onclick="event.stopPropagation();toggleExpand('details-{{ rec.id }}')">
     
    🔍</button>
<button class="btn btn-sm btn-info rounded-circle shadow btn-toggle"
        onclick="toggleAccordion('hourly-{{ rec.id }}', this, '{{ rec.id }}', 'hourly')">⏰</button>
<button class="btn btn-sm btn-info rounded-circle shadow btn-toggle"
        onclick="toggleAccordion('m30-{{ rec.id }}', this, '{{ rec.id }}', 'm30')">⏱️</button>
<button class="btn btn-sm btn-info rounded-circle shadow btn-toggle"
        onclick="toggleAccordion('m5-{{ rec.id }}', this, '{{ rec.id }}', 'm5')">⏳</button>
<button class="btn btn-sm btn-info rounded-circle shadow btn-toggle"
        onclick="toggleAccordion('m2-{{ rec.id }}', this, '{{ rec.id }}', 'm2')">⌛</button>



  </div>
</td>

      </tr>
 <!-- FII/DII Expand -->
      <tr id="details-{{ rec.id }}" class="expand-row" style="display:none;">
        <td colspan="13">
          <table style="width:100%;border-collapse:collapse;margin-top:10px;">
            <thead style="background:#5a67d8;color:#fff;">
              <tr>
                <th>FII Buy</th><th>FII Sell</th><th>FII Net</th>
                <th>DII Buy</th><th>DII Sell</th><th>DII Net</th>
              </tr>
            </thead>
            <tbody>
              <tr style="background:#f8f9fa;">
                <td>{{ rec.fii_buy }}</td>
                <td>{{ rec.fii_sell }}</td>
                <td>{{ rec.fii_net }}</td>
                <td>{{ rec.dii_buy }}</td>
                <td>{{ rec.dii_sell }}</td>
                <td>{{ rec.dii_net }}</td>
              </tr>
            </tbody>
          </table>
        </td>
      </tr>
    <!-- Hourly Accordion -->
<tr id="hourly-{{ rec.id }}" class="accordion-content hourly" style="display:none;">
  <td colspan="13">
    <div class="accordion-wrapper">
      <div class="accordion-body">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Time</th>
              <th>Open</th>
              <th>High</th>
              <th>Low</th>
              <th>Close</th>
              <th>Points</th>
              <th>Decision</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="7">⏳ Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </td>
</tr>

<!-- M30 Accordion -->
<tr id="m30-{{ rec.id }}" class="accordion-content m30" style="display:none;">
  <td colspan="13">
    <div class="accordion-wrapper">
      <div class="accordion-body">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Time</th>
              <th>Open</th>
              <th>High</th>
              <th>Low</th>
              <th>Close</th>
              <th>Points</th>
              <th>Decision</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="7">⏳ Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </td>
</tr>

<!-- M5 Accordion -->
<tr id="m5-{{ rec.id }}" class="accordion-content m5" style="display:none;">
  <td colspan="13">
    <div class="accordion-wrapper">
      <div class="accordion-body">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Time</th>
              <th>Open</th>
              <th>High</th>
              <th>Low</th>
              <th>Close</th>
              <th>Points</th>
              <th>Decision</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="7">⏳ Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </td>
</tr>

<!-- M2 Accordion -->
<tr id="m2-{{ rec.id }}" class="accordion-content m2" style="display:none;">
  <td colspan="13">
    <div class="accordion-wrapper">
      <div class="accordion-body">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Time</th>
              <th>Open</th>
              <th>High</th>
              <th>Low</th>
              <th>Close</th>
              <th>Points</th>
              <th>Decision</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="7">⏳ Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </td>
</tr>


      {% endfor %}
    </tbody>
  </table>

  <!-- Pagination -->
  <div class="pagination">
    {% if records.has_previous %}
      <a href="?page={{ records.previous_page_number }}{% if filter_option %}&filter={{ filter_option }}{% endif %}">« Prev</a>
    {% endif %}
    {% for num in records.paginator.page_range %}
      {% if records.number == num %}
        <span class="current">{{ num }}</span>
      {% elif num > records.number|add:-3 and num < records.number|add:3 %}
        <a href="?page={{ num }}{% if filter_option %}&filter={{ filter_option }}{% endif %}">{{ num }}</a>
      {% endif %}
    {% endfor %}
    {% if records.has_next %}
      <a href="?page={{ records.next_page_number }}{% if filter_option %}&filter={{ filter_option }}{% endif %}">Next »</a>
    {% endif %}
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Modal -->
<div class="modal fade" id="summaryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      
      <!-- Modal Header -->
      <div class="modal-header text-white" style="background:linear-gradient(135deg,#7b2ff7,#5a67d8);">
        <h5 class="modal-title fw-bold">📖 Daily Market Summary</h5>
        <div class="ms-auto d-flex gap-2 align-items-center">
          <select id="langSelect" class="form-select form-select-sm bg-light border-0 shadow-sm" onchange="loadSummary()">
            <option value="en">English</option>
            <option value="hi">हिंदी</option>
            <option value="te">తెలుగు</option>
            <option value="ta">தமிழ்</option>
            <option value="kn">ಕನ್ನಡ</option>
          </select>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body bg-light p-4" style="max-height:75vh;overflow-y:auto;">
        <div id="summaryContent" class="text-muted">⏳ Generating summary...</div>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let selectedDate = null;

function openSummaryModal(date) {
  selectedDate = date;
  loadSummary();
  new bootstrap.Modal(document.getElementById('summaryModal')).show();
}
const currentIndex = "{{ index }}"; 
function loadSummary() {
  const lang = document.getElementById("langSelect").value;
  document.getElementById("summaryContent").innerHTML = "⏳ Generating summary...";
  fetch(`/marketdata/summary_api?date=${selectedDate}&lang=${lang}&index=${currentIndex}`)
    .then(res => res.json())
    .then(data => renderSummary(data))
    .catch(err => {
      console.error(err);
      document.getElementById("summaryContent").innerHTML = "⚠ Failed to load summary";
    });
}

function renderSummary(data) {
  let html = "";

  // Quick Summary
  if (data.summary_lines?.length) {
    const recapLine = data.summary_lines[1];
    const openVal = parseFloat(recapLine.match(/opened (\d+\.?\d*)/)[1]);
    const highVal = parseFloat(recapLine.match(/High (\d+\.?\d*)/)[1]);
    const lowVal = parseFloat(recapLine.match(/Low (\d+\.?\d*)/)[1]);
    const closeVal = parseFloat(recapLine.match(/Close (\d+\.?\d*)/)[1]);
    const pctChange = (((closeVal - openVal) / openVal) * 100).toFixed(2);

    html += `
    <div class="section-header quick-summary"><span class="left">📋 Quick Summary</span></div>
    <div class="p-3 bg-white rounded shadow-sm mb-3">
      <b>Date:</b> ${data.summary_lines[0]}<br/>
      <b>Open:</b> ${openVal}, <b>High:</b> ${highVal}, <b>Low:</b> ${lowVal}, <b>Close:</b> ${closeVal}<br/>
      <b>Bias:</b> ${data.bias}, <b>PCR:</b> ${data.flows.pcr}, <b>% Chg:</b> ${pctChange}%
    </div>`;
  }

  // Market Story
  if (data.narrative) {
    html += `<div class="section-header market-story"><span class="left">📘 Market Story</span></div>
    <div class="p-3 bg-white rounded shadow-sm mb-3">${data.narrative}</div>`;
  }

  // Trend Warning
  if (data.trend_warning) {
    html += `<div class="section-header trend-warning"><span class="left">⚠️ Trend Alert</span></div>
    <div class="p-3 bg-white rounded shadow-sm mb-3">${data.trend_warning}</div>`;
  }

  // Recap
  let bull = data.summary_lines.filter(l=>l.includes("Bullish")).length;
  let bear = data.summary_lines.filter(l=>l.includes("Bearish")).length;
  let neu = data.summary_lines.filter(l=>l.includes("Neutral")).length;
  html += `<div class="section-header recap">
      <span class="left">📊 Recap</span>
      <span>
        <span class="badge badge-pos">${bull} Bullish</span>
        <span class="badge badge-neg">${bear} Bearish</span>
        <span class="badge badge-neu">${neu} Neutral</span>
      </span>
    </div><div class="p-3 bg-white rounded shadow-sm mb-3"><ul>`;
  data.summary_lines.forEach(line => html += `<li>${line}</li>`);
  html += `</ul></div>`;

  // News
  if (data.news?.length) {
    let pos = data.news.filter(n=>n.sentiment==="Positive").length;
    let neg = data.news.filter(n=>n.sentiment==="Negative").length;
    let neuNews = data.news.filter(n=>n.sentiment==="Neutral").length;
    html += `<div class="section-header news">
      <span class="left">📰 Key News</span>
      <span>
        <span class="badge badge-pos">${pos} 🟢</span>
        <span class="badge badge-neg">${neg} 🔴</span>
        <span class="badge badge-neu">${neuNews} ⚪</span>
      </span>
    </div><div class="p-3 bg-white rounded shadow-sm mb-3"><ul>`;
    data.news.forEach(n => {
      let emoji = n.sentiment==="Positive"?"🟢":n.sentiment==="Negative"?"🔴":"⚪";
      html += `<li>${emoji} ${n.title} <small class="text-muted">(${n.source})</small></li>`;
    });
    html += `</ul></div>`;
  }

  // Intraday
  if (data.intraday_traps?.length) {
    html += `<div class="section-header intraday"><span class="left">🕒 Intraday Timeline</span></div>
      <div class="p-3 bg-white rounded shadow-sm mb-3">
      <table class="table table-sm table-striped">
        <thead><tr><th>Time</th><th>Move</th><th>Note</th></tr></thead><tbody>`;
    data.intraday_traps.forEach(s => {
      let c = s.direction==="up"?"text-success":"text-danger";
      html += `<tr><td>${s.time}</td><td class="${c}">${s.points}</td><td>${s.annotation}</td></tr>`;
    });
    html += `</tbody></table></div>`;
  }

  document.getElementById("summaryContent").innerHTML = html;
}

function resetAll(){ window.location.href="{% url 'record_list' %}"; }
function toggleExpand(id){
  const row = document.getElementById(id);
  row.style.display = row.style.display === "table-row" ? "none" : "table-row";
}

function toggleAccordion(id, btn, recId, interval){
  const row = document.getElementById(id);

  if(row.style.display==="table-row"){
    row.style.display="none";
    btn.classList.remove("active");
    return;
  }

  // Hide all other accordions
  document.querySelectorAll(".accordion-content").forEach(r=>r.style.display="none");
  document.querySelectorAll(".btn-toggle").forEach(b=>b.classList.remove("active"));

  // Show this one
  row.style.display="table-row";
  btn.classList.add("active");

  // Load content if empty
  if(!row.dataset.loaded){
    fetch(`/marketdata/accordion/${recId}/${interval}/`)
      .then(res => res.text())
      .then(html => {
        row.querySelector("td").innerHTML = html;
        row.dataset.loaded = "true";
      })
      .catch(err => {
        row.querySelector("td").innerHTML = "⚠ Failed to load data";
      });
  }
}

document.addEventListener("DOMContentLoaded", function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  });
  function loadAccordion(type, recId) {
  const row = document.getElementById(`${type}-${recId}`);
  const td = row.querySelector("td");

  // Hide all accordions of this record
  document.querySelectorAll(`[id$="-${recId}"]`).forEach(r => r.style.display = "none");

  // Show current
  row.style.display = "table-row";
  td.innerHTML = `⏳ Loading ${type} data...`;

  fetch(`/marketdata/accordion/${recId}/${type}/`)
    .then(res => res.text())
    .then(html => td.innerHTML = html)
    .catch(err => {
      console.error(err);
      td.innerHTML = "⚠️ Failed to load data";
    });
}
function toggleAccordion(id, btn, recId, interval) {
  const row = document.getElementById(id);
  const wrapper = row.querySelector(".accordion-wrapper");

  // If already open → close
  if (wrapper.classList.contains("open")) {
    wrapper.classList.remove("open");
    btn.classList.remove("active");
    return;
  }

  // Close all other accordions
  document.querySelectorAll(".accordion-wrapper.open").forEach(w => w.classList.remove("open"));
  document.querySelectorAll(".btn-toggle.active").forEach(b => b.classList.remove("active"));

  // Ensure row is visible & open this one
  row.style.display = "table-row";
  wrapper.classList.add("open");
  btn.classList.add("active");

  // Load content if not already loaded
  if (!row.dataset.loaded) {
    fetch(`/marketdata/accordion/${recId}/${interval}/`)
      .then(res => res.text())
      .then(html => {
        row.querySelector("tbody").innerHTML = html;
        row.dataset.loaded = "true";
      })
      .catch(err => {
        row.querySelector("tbody").innerHTML =
          "<tr><td colspan='7'>⚠ Failed to load data</td></tr>";
      });
  }
}

// Hide row completely after collapse animation
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".accordion-wrapper").forEach(wrapper => {
    wrapper.addEventListener("transitionend", () => {
      if (!wrapper.classList.contains("open")) {
        wrapper.closest("tr").style.display = "none";
      }
    });
  });

  // Fade + shadow effects
  document.querySelectorAll(".accordion-body").forEach(body => {
    const updateEffects = () => {
      const scrollTop = body.scrollTop;
      const scrollHeight = body.scrollHeight;
      const clientHeight = body.clientHeight;

      // Top fade toggle
      if (scrollTop > 0) body.classList.add("has-top-fade");
      else body.classList.remove("has-top-fade");

      // Bottom fade toggle
      if (scrollTop + clientHeight < scrollHeight - 1)
        body.classList.add("has-bottom-fade");
      else body.classList.remove("has-bottom-fade");

      // Dynamic shadow
      const intensity = Math.min(scrollTop / 50, 1);
      const alpha = 0.15 + (0.25 * intensity);
      body.style.setProperty(
        "--header-shadow",
        `0 4px 10px rgba(0,0,0,${alpha.toFixed(2)})`
      );
    };

    updateEffects();
    body.addEventListener("scroll", updateEffects);
  });
});



</script>
</body>
</html>
